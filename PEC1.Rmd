---
title: "Análisis de datos ómicos"
subtitle: "PEC1"
author: 'Lorca Orloff, Pablo'
#date: '`r format(Sys.Date(),"%e de %B, %Y")`'
bibliography: references.bib
output:
  pdf_document: 
    latex_engine: xelatex
    toc: true
    toc_depth: 2
    fig_caption: true
    fig_width: 8
    fig_height: 4
    number_sections: true
link-citations: true
header-includes:
  - \usepackage{titling}
  - \setlength{\droptitle}{-2cm}
  - \usepackage{tocloft}
  - \setlength{\cftbeforesecskip}{0pt}
  - \usepackage{caption}
  - \captionsetup[table]{name=Tabla}
mainfont: "Times New Roman"
lang: "es"
encoding: UTF-8
#params:
---

:::: {align="justify"}
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
options(width = 100)
```

```{r libraries, include=FALSE}
# Verifica/Instala y carga paquetes
if (!require("knitr")) install.packages("knitr")
library(knitr)

if (!require("SummarizedExperiment")) BiocManager::install("SummarizedExperiment")
library(SummarizedExperiment)

if (!require("openxlsx")) install.packages("openxlsx")
library(openxlsx)
```

# Resumen

a

# Objetivos

Los objetivos de este trabajo son los siguientes:

1.  Analizar de manera exploratoria un conjunto de datos ómicos.

2.  Crear y utilizar un objeto de la clase `SummarizedExperiment`.

# Métodos

## Obtención set de datos

Los datos utilizados en este trabajo se obtuvieron del repositorio de *Github* de *nutrimetabolomics* @nutrimetabolomics_metaboData. Se escogió el set de datos referente a la enfermedad caquexia (2024-Cachexia).

## Obtención set de datos

Para almacenar y contener la data y metadata a trabajar, se generó un objeto `SummarizedExperiment` [@SummarizedExperiment].

## Análisis de datos

Para un análisis estadístico de los datos, se visualizaron a través de gráficos de cajas e histogramas, además de realizar una prueba de Shapiro-Wilks.

Para evaluar la correlación entre los metabolitos se analizó mediante la función `cor`.

Para estudiar la variabilidad en un conjunto de datos multivariantes se realizó un análisis de componente principal (PCA) utilizando la función `prcomp` normalizando los datos con la opción `scale. = TRUE`.

# Resultados

## Cargar data

Se procede a cargar la data con de `human_cachexia` y la metadata.

```{r}
#Cargar archivos data y metadata
data <- read.csv('human_cachexia.csv', check.names = FALSE)
data_info <- openxlsx::read.xlsx("Data_Catalog.xlsx")
```

## Exploración de la data

Se procede a realizar una primera exploración de los datos.

```{r}
# Dimensión
dim(data)

# Nombre variables 
colnames(data)

# Presencia datos faltantes
any(is.na(data))

#Proporción Caquexia/Control
table(data$`Muscle loss`)
```

La data consta de 77 observaciones y 65 variables sin datos faltantes. De las 65 variables, la primera corresponde al identificador del paciente, la segunda corresponde si el paciente presenta caquexia o pertenece al grupo control, y luego los 63 metabolitos medidos.

## Generación de `SummarizedExperiment`

Se generó el objeto `SummarizedExperiment` considerando las primeras dos columnas,`Patient ID` y `Muscle loss`, como información descriptiva (`col_data`), por otra parte, los valores de los metabolitos se consideraro para la matriz de expresión (`assays`).

```{r}
# Matriz de expresión - Sin 'Patient ID' y 'Muscle loss'
exprs <- as.matrix(data[, -(1:2)])

# Extraer componentes
assay_data <- t(as.matrix(data[, -c(1, 2)]))  # Matriz transpuesta de metabolitos
row_data <- DataFrame(metabolite = colnames(data)[-c(1, 2)])  # Nombres metabolitos
col_data <- data.frame(`Muscle loss` = data$`Muscle loss`)  # Info descriptiva 
rownames(col_data) <- data$`Patient ID`  # IDs pacientes - nombres de fila
metadata_list <- list(DataInfo = data_info[6,]) # Metadata

# Objeto SummarizedExperiment
se <- SummarizedExperiment::SummarizedExperiment(
    assays = list(metabolites = assay_data),
    rowData = row_data,
    colData = col_data,
    metadata = metadata_list
)
```

## Análisis de la data

### Valores atípicos

Al agrupar y analizar los datos según su condición `Muscle.loss` se observa que, en promedio, los metabolitos de los pacientes con caquexia son más altos que los pacientes control. Adicionalmente, todas las muestras presentan datos estadísticamente anómalos (Ver Figura Anexo 1).

### Distribución

La distribución que presentan los datos de cada metabolito según su condición `Muscle.loss`, por lo general, no muestran presentar una distribución normal (Ver Figura Anexo 2), lo cual se corrobora al realizar un test de Shapiro-Wilks (Ver Anexo 3), en donde en ningún caso hay evidencia para confirmar normalidad.

### Correlación

```{r}
# Matriz de correlación
m_cor <- cor(t(assay(se)))

# Elimina parte inferior
m_cor[lower.tri(m_cor)] <- NA

# Límite cor 0.7 - Exluye diagonal
sum(abs(m_cor) > 0.7 & abs(m_cor) != 1, na.rm = TRUE)

# Límite cor 0.3 - Exluye diagonal
sum(abs(m_cor) > 0.3 & abs(m_cor) != 1, na.rm = TRUE)
```

Al evaluar las posibles correlaciones entre metabolitos, se encontró que 1140 parejas de metabolitos podrían presentar algún grado de correlación lineal significativa, y 140 presentarían una correlación lineal fuerte.

### Análisis de componentes principales

```{r, include=FALSE}
options(width = 95)
```

Se realizó un análisis de componentes principales.

```{r}
# PCA
pca <- prcomp(t(assay(se)), scale. = TRUE)

# Resultados
summary(pca)
```

El análisis muestra que el primer componente (PC1) explica aproximadamente un 40,43% de la variabilidad de los datos, seguido del segundo componente (PC2) que explica aproximadamente un 8,18% de la variabilidad de los datos. Los tres primeros componentes (PC1 + PC2 + PC3) explicarían el 53,94% variabilidad de los datos.

# Discusión

## `ExpressionSet` y `SummarizedExperiment`

Tanto `ExpressionSet` como `SummarizedExperiment` son clases de R que permiten crear objetos para almacenar y manipular datos ómicos. La clase `SummarizedExperiment` ofrece una mayor flexibilidad a la hora integrar metadata y manejar distintos tipos de datos, mientras que `ExpressionSet` está más enfocada en datos de tipo microarreglos y una estructura más rígida [@Biobase; @SummarizedExperiment].

# Conclusiones

a

\newpage

# Referencias

::: {#refs}
:::

\newpage

# Anexo

**Anexo 1**

```{r fig.cap = "Boxplot de cada metabolito separado según condición `Muscle_loss`. En celeste el grupo que presenta caquexia y en verde claro el grupo control.", echo=FALSE, fig.width = 8, fig.height = 2.5}
# Figura 1 Anexo - Boxplot de cada metabolito ~ Muscle.loss
par(mfrow = c(1, 6))
# Iteración de cada metabolito
for (i in 1:nrow(assay(se))) {
  metabolito <- rownames(assay(se))[i]
  
  # Boxplot Metabolito ~ Muscle_loss
  boxplot(assay(se)[i, ] ~ colData(se)$Muscle.loss,
          xlab = NULL,
          ylab = metabolito,
          col = c("lightblue", "lightgreen"),
          las = 2)
}
```

Figura Anexo 1: Boxplot de cada metabolito separado según condición `Muscle_loss`. En celeste el grupo que presenta caquexia y en verde claro el grupo control.\
\
**Anexo 2**

```{r fig.cap = "Distribución de cada metabolito separado según condición `Muscle_loss`. En celeste el grupo que presenta caquexia y en verde claro el grupo control.", echo=FALSE, fig.width = 8, fig.height = 2.5}
# Figura 2 Anexo - Histograma de cada metabolito ~ Muscle.loss
par(mfrow = c(1, 6))
# Iteración de cada metabolito
for (i in 1:nrow(assay(se))) {
  metabolito <- rownames(assay(se))[i]
  
  # Caquexia -  Control
  caq <- as.numeric(assay(se)[i, colData(se)$Muscle.loss == "cachexic"])
  control <- as.numeric(assay(se)[i, colData(se)$Muscle.loss == "control"])
  
  # Histogramas
  hist(caq, 
       main = 'Caquexia',
       xlab = metabolito, ylab = NULL,
       col = "lightblue",
       las = 2)
  
  hist(control, 
       main = 'Control',
       xlab = NULL, ylab = NULL,
       col = "lightgreen", 
       las = 2)
}
```

Figura Anexo 2: Distribución de cada metabolito separado según condición `Muscle_loss`. En celeste el grupo que presenta caquexia y en verde claro el grupo control.

**Anexo 3**

```{r}
# Evaluar normalidad

metabolitos <- character()
v_caq_p <- character()
v_con_p <- character()
v_caq_w <- character()
v_con_w <- character()

for (i in 1:nrow(assay(se))) {
  metabolito <- rownames(assay(se))[i]
  
  caq <- as.numeric(assay(se)[i, colData(se)$Muscle.loss == "cachexic"])
  conl <- as.numeric(assay(se)[i, colData(se)$Muscle.loss == "control"])
  
  # Test normalidad
  test_caq <- shapiro.test(caq)
  test_con <- shapiro.test(control)
  
  # valor p < 0.05
  p_caq <- ifelse(test_caq$p.value  > 0.05, "normal", "no normal")
  p_con <- ifelse(test_con$p.value > 0.05, "normal", "no normal")
  
  # valor W > 0.95
  w_caq <- ifelse(test_caq$statistic  > 0.95, "Posible normal", "no normal")
  w_con <- ifelse(test_con$statistic > 0.95, "Posible normal", "no normal")
  
  metabolitos <- c(metabolitos, metabolito)
  
  v_caq_p <- c(v_caq_p, p_caq)
  v_con_p <- c(v_con_p, p_con)
  
  v_caq_w <- c(v_caq_w, w_caq)
  v_con_w <- c(v_con_w, w_con)
}

df_shapiro_p <- data.frame(
  Metabolito = metabolitos,
  Cachexia = v_caq_p,
  Control = v_con_p,
  stringsAsFactors = FALSE
)

df_shapiro_w <- data.frame(
  Metabolito = metabolitos,
  Cachexia = v_caq_w,
  Control = v_con_w,
  stringsAsFactors = FALSE
)

table(df_shapiro_p$Cachexia)
table(df_shapiro_p$Control)

table(df_shapiro_w$Cachexia)
table(df_shapiro_w$Control)
```
::::
